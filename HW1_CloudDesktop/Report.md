# 私有云的部署 - 让你的计算机也能提供云桌面服务

> 私有云(Private Clouds)是为一个客户单独使用而构建的，因而提供对数据、安全性和服务质量的最有效控制。该公司拥有基础设施，并可以控制在此基础设施上部署应用程序的方式。私有云可部署在企业数据中心的防火墙内，也可以将它们部署在一个安全的主机托管场所，私有云的核心属性是专有资源。
>
> 想到云计算、云平台，立马觉得高深莫测。如果你想搭建自己使用的桌面云，使用 VirtualBox 这样的开源软件，仅需要几十分钟或几个小时就能如你所愿。

[TOC]



## 实验目的

1. 初步了解虚拟化技术，理解云计算的相关概念
2. 理解系统工程师面临的困境
3. 理解自动化安装、管理（DevOps）在云应用中的重要性



## 实验环境与要求

1. 用户通过互联网，使用微软远程桌面，远程访问你在PC机上创建的虚拟机
2. 虚拟机操作系统 Centos，Ubuntu，或 你喜欢的 Linux 发行版，能使用 NAT 访问外网



## 实验内容

### 1. 安装 VirtualBox

   - 创建虚拟机内部虚拟网络，使得 Vbox 内部虚拟机可以通过它，实现虚拟机之间、虚拟机与主机的通讯

     1. VirtualBox菜单 ：管理 -> 主机网络管理器，创建一块虚拟网卡，网络地址分配：192.168.100.1/24

        ![1567837590892](.\pic\1567837590892.png)

     2. 在主机 windows 命令行窗口输入 `ipconfig` 就可以看到 `VirtualBox Host-Only Network #?:` 的网卡

        ![1567837682899](.\pic\1567837682899.png)

        

### 2. 创建Linux虚拟机

   - 下载 Linux 发行版镜像

     从阿里云开源镜像[下载CentOS-Minimal](http://mirrors.aliyun.com/centos/7.6.1810/isos/x86_64/)

   - 用 VBox 创建虚拟机

     ![1567836584488](.\pic\1567836584488.png)

     ![1567838031095](.\pic\1567838031095.png)

- 配置网络

  设置 -> 网络 -> 网卡2 -> 勾选 “启用网络连接” -> 指定连接方式为 “ 仅主机(Host -Only)网络”

  ![1567838278413](.\pic\1567838278413.png)



### 3. 安装 Base 虚拟机

> 利用虚拟化软件提供的虚拟机复制功能，避免每次安装 OS 系统的痛苦

 - 按提示安装，直到完成

   ![1567838479795](.\pic\1567838479795.png)

选择好启动盘之后 -> 选择 "Install CentOS"/"Test this media & Install CentOS"皆可 -> 设置语言等 即可完成安装

重启进入该界面

![1567839879631](.\pic\1567839879631.png)

- 升级 OS 系统内核

  1. 获取 wget, `yum install wget`

     可能会出现如下的问题：

     ![1567840339963](.\pic\1567840339963.png)

     关于该问题的详细解释请查看该博客：

     解决方案：
     
     - 终端输入
     
       ```shell
       vi /etc/sysconfig/network-scripts/ifcfg-enp0sX 	#X取决于你的网卡号
       ```
     
     - 修改
     
       ```shell
       ONBOOT=yes #设置为开机启动
       ```
     
     - 保存退出( :wq )并重启网络
     
       ```shell
       service network restart
       ```
     
  2. 接着就可以运行`yum install wget`

     ![1567844288656](.\pic\1567844288656.png)

  3. 配置源

     > yum需要一个yum库，也就是yum源。默认情况下，CentOS就有一个yum源。在/etc/yum.repos.d/目录下有一些默认的配置文件

     - 打开centos的yum文件夹

     - 备份系统原来的repo文件

       ![1567845140153](.\pic\1567845140153.png)

     - 用wget下载repo文件并替换

       ![1567845118490](.\pic\1567845118490.png)

       ![1567845171440](.\pic\1567845171440.png)

     - 执行yum源更新命令

       ```shell
       yum clean all
       yum makecache
       yum update    
       ```

- 检查网卡配置

  1. 配置网络的UI界面 `nmtui`，配置第二块网卡地址

     输入命令`nmcli d`可以发现enp0s8的网卡尚未联通，因为我们没有配置Host-Only的IP

     ![1567871048573](.\pic\1567871048573.png)

     ![1567845944355](.\pic\1567845944355.png)

     ![1567846065914](.\pic\1567846065914.png)

     ​	将第二块网卡的地址配置为192.168.100.2/24	网关配置为192.168.100.1

     ![1567846305614](.\pic\1567846305614.png)

     ​	输入命令`nmcli d`可以看到此时第二块网卡也联通了

     ![1567846261023](.\pic\1567846261023.png)
  
     ![1567846366170](.\pic\1567846366170.png)
  
  2. ping 主机，例如： `ping 192.168.100.1`
  
     ![1567846419743](.\pic\1567846419743.png)
  
     ​	ping 外网(www.baidu.com)
  
     ![1567846507520](.\pic\1567846507520.png)

### 4. 安装/复制虚拟机

  1. 点击 centos-base 选择复制，输入新虚拟机的名，注意必须 **选择重新初始化所有网卡的 MAC 地址**

     ![1567846760970](.\pic\1567846760970.png)

  2. 然后选 **链接复制**

     ![1567846787647](.\pic\1567846787647.png)

  3. 配置主机名和第二块网卡

     ![1567859383822](.\pic\1567859383822.png)

     - 使用 `nmtui` 修改主机名和第二块网卡IP地址

       ![1567859726255](.\pic\1567859726255.png)

       ![1567859796222](.\pic\1567859796222.png)

     - 重启，然后验证在主机上，应能 ping 到这个地址，且能通过 ssh 访问该虚拟机（windows 需启动 git bash） 

       ping 网关 联通：

       ![1567859951530](.\pic\1567859951530.png)

       ping 外网 联通：

       ![1567859994632](.\pic\1567859994632.png)

       宿主主机 ping 虚拟机 联通
       
       ![1567860182159](.\pic\1567860182159.png)
       
       在宿主主机通过ssh连接虚拟机成功
       
       ![1567860732096](.\pic\1567860732096.png)
       
       > The authenticity of host '192.168.100.3 (192.168.100.3)' can't be established
       >
       > 关于ssh互信的详细问题可看此博客

  4. 安装centos桌面

     - 重新分配虚拟机CPU，内存，显存

       将 处理器个数从一个升为两个，显存调到最高128MB

       ![1567863763180](.\pic\1567863763180.png)

     - 安装桌面 `yum groupinstall "GNOME Desktop"`

       ![1567863172964](.\pic\1567863172964.png)

     - 设置启动目标为桌面 `ln -sf /lib/systemd/system/runlevel5.target /etc/systemd/system/default.target`

       ![1567863275362](.\pic\1567863275362.png)

       ![1567864045976](.\pic\1567864045976.png)

     - 安装 VirtualBox 增强功能

       1. 先安装kernel-devel和gcc

          ![1567864545580](.\pic\1567864545580.png)

       2. 通过VirtualBox的 设备 | 安装增强功能... 菜单可以加载VBoxGuestAdditions.iso，可以直接点击Run安装或者执行

          ![1567864803828](.\pic\1567864803828.png)

     - 安装 Chrome 浏览器

       1. 下载 rpm 包

          从[chrome64bit.com](https://www.chrome64bit.com/index.php/google-chrome-64-bit-for-linux)下载后缀为rpm的安装包

          ![1567865512504](.\pic\1567865512504.png)

       2. 用 yum 安装
     
          ```shell
     sudo yum localinstall google-chrome-stable_current_x86_64.rpm
          ```
     
          ![1567865623207](.\pic\1567865623207.png)
          
          ![1567867905989](.\pic\1567867905989.png)

### 5. 配置用远程桌面访问你的虚拟机

   - 增加VirtualBox远程显示扩展

     1. 从[官网](https://www.oracle.com/virtualization/technologies/vm/downloads/virtualbox-downloads.html#extpack)下载VirtualBox的扩展包——Oracle VM VirtualBox Extension Pack

     2. 添加到 VitualBox 管理 -> 全局设定 -> 扩展 -> 添加包

        ![1567868229149](.\pic\1567868229149.png)

     3. 按提示完成安装

        ![1567868293582](.\pic\1567868293582.png)

   - 设置虚拟机端口

     选定虚拟机，右键 设置 -> 显示 -> 远程桌面，勾选`启用服务器`，修改合适的服务器端口号

     ![1567868404346](.\pic\1567868404346.png)

   - 开启虚拟机，测试能否访问

     win+R -> 运行`mstsc`（远程桌面连接）-> 以 `ip:端口号` 的格式进行连接

     在宿主主机尝试远程桌面连接(使用本地回送地址127.0.0.1)

     ![1567869301581](.\pic\1567869301581.png)

![1567869320137](.\pic\1567869320137.png)

在与宿主主机处于同一局域网的其他主机访问 (宿主主机ip地址为172.18.61.27)![1567869669725](.\pic\1567869669725.png)

![1567869689750](.\pic\1567869689750.png)

**两者都成功访问，此次实验完成**